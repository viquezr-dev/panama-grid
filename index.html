<!DOCTYPE html>
<html lang="es">
<head>
    <title>SISTEMAS POSTALES DE PANAM√Å (COTEL)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; background: #ddd; }
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 5000; display: flex; gap: 5px; 
            background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px;
        }
        #search-input { flex: 1; border: 1px solid #ccc; padding: 5px; outline: none; font-family: monospace; font-size: 14px; text-transform: uppercase; border-radius: 4px; }
        #search-btn { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .leaflet-top.leaflet-right { margin-top: 70px !important; }
        
        .leaflet-tooltip.watermark-tooltip { background: transparent!important; border: none!important; box-shadow: none!important; color: rgba(0,0,0,0.5); font-weight: bold; font-family: monospace; text-shadow: 1px 1px 0px white; pointer-events: none; }
        .label-macro { color: #1a73e8!important; font-size: 15px; }
        .label-micro { color: #e67e22!important; font-size: 11px; }

        .popup-header { font-weight: bold; display: block; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 3px; text-align: center; font-size: 11px; text-transform: uppercase; color: #666; }
        .codigo-final { background: #1a2a6c; color: white; padding: 12px; border-radius: 6px; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 8px; border: 2px solid #f1c40f; }
        .btn-container { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .btn-maps { background: #4285F4; color: white !important; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: bold; }
        .btn-ws { background: #25D366; color: white !important; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: bold; }
        .btn-cercana { background: #003366; color: white !important; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; width: 100%; margin-top: 5px; }
        
        .locate-button {
            position: absolute; bottom: 130px; right: 10px; z-index: 1000; background: white; width: 40px; height: 40px; 
            border-radius: 4px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: none; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .inv { background: none; border: none; }
        .error-msg { color: #c0392b; font-weight: bold; text-align: center; padding: 10px; font-size: 12px; line-height: 1.4; }

        .map-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: none;
            text-align: center;
            pointer-events: none; 
            width: 100%;
        }
        
        .map-title h1 {
            margin: 0;
            font-size: 22px;
            color: #1a2a6c;
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #fff, -1px -1px 0px #fff, 1px -1px 0px #fff, -1px 1px 0px #fff;
        }
        
        .map-title span {
            font-size: 11px;
            color: #333;
            display: block;
            font-weight: bold;
            margin-top: -2px;
            text-shadow: 1px 1px 0px #fff;
        }
    </style>
</head>
<body>
<div class="map-title">
    <h1>SISTEMAS POSTALES DE PANAM√Å</h1>
    <span>DIRECCI√ìN GENERAL DE CORREOS Y TEL√âGRAFOS (COTEL)</span></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="ULTIMOS 6 D√çGITOS..." maxlength="6">
    <button id="search-btn">IR</button>
</div>

<button class="locate-button" onclick="findMe()">üß≠</button>
<div id="mapid"></div>

<script>
function snapToGrid(coord, origin, step) {
    // Usamos un epsilon m√°s peque√±o y una l√≥gica de redondeo m√°s estable
    const delta = coord - origin;
    const itemIndex = Math.floor(delta / step + 0.0000000001); 
    return origin + (itemIndex * step);
}
  
const ORIGIN = { lat: 10.0, lng: -83.0 };
const PANAMA_LIMITS = { N: 10.0, S: 7.0, W: -83.0, E: -77.0 };
const PARAMS = {
    RES_MACRO: 0.143, 
    RES_MICRO: 0.143 / 24,
    RES_NANO: (0.143 / 24) / 25,
    ALFA: "23456789ABCDEFGHJKLMNPQRSTVWXYZ",
    MACRO_X_COUNT: Math.ceil((77.0 - 83.0) / -0.143)
};

const mymap = L.map('mapid', { zoomSnap: 0.1, zoomControl: false }).setView([8.5, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);
L.control.zoom({ position: 'bottomright' }).addTo(mymap);

const styleZonaNormal = { color: "#333", weight: 1.5, fillOpacity: 0.1, fillColor: "#3498db" };
const styleZonaHover = { color: "#f1c40f", weight: 3, fillOpacity: 0.3, fillColor: "#3498db" };

const layerZonas = L.geoJSON(null, { 
    style: styleZonaNormal,
    onEachFeature: function(feature, layer) {
        layer.on({
            mouseover: function(e) {
                e.target.setStyle(styleZonaHover);
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) e.target.bringToFront();
            },
            mouseout: function(e) {
                layerZonas.resetStyle(e.target);
            },
            click: function(e) {
                seleccionar(e.latlng.lat, e.latlng.lng, feature.properties.VM_LEVEL);
                L.DomEvent.stopPropagation(e);
            }
        });
    }
}).addTo(mymap);

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerNano = L.layerGroup().addTo(mymap);
const layerRutas = L.layerGroup().addTo(mymap);
const layerEstafetas = L.layerGroup().addTo(mymap);
const layerMiUbicacion = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

fetch('estafetas.geojson').then(r => r.json()).then(data => layerZonas.addData(data));
fetch('estafetasl.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, { style: {color: 'red', weight: 2}, onEachFeature: (f,l) => l.bindPopup(`<b>RUTA:</b> ${f.properties.RUTA}`) }).addTo(layerRutas);
});
fetch('estafetasp.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, { pointToLayer: (f,ll) => L.circleMarker(ll, {radius: 6, fillColor: 'green', color: '#fff', weight: 2, fillOpacity: 1}), onEachFeature: (f,l) => l.bindPopup(`<b>ESTAFETA:</b> ${f.properties.ESTAF_NAME}`) }).addTo(layerEstafetas);
});

function isPointInPolygon(latlng, poly) {
    let inside = false;
    let x = latlng.lng, y = latlng.lat;
    let parts = poly.getLatLngs();
    if (!Array.isArray(parts[0][0])) parts = [parts]; 
    for (let i = 0; i < parts.length; i++) {
        let nodes = parts[i][0] instanceof L.LatLng ? parts[i] : parts[i][0];
        for (let j = 0, k = nodes.length - 1; j < nodes.length; k = j++) {
            let xi = nodes[j].lng, yi = nodes[j].lat;
            let xj = nodes[k].lng, yj = nodes[k].lat;
            if (((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) inside = !inside;
        }
    }
    return inside;
}

function encode(num, len) {
    let s = ""; let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { s = PARAMS.ALFA[n % 30] + s; n = Math.floor(n / 30); }
    return s;
}
function decode(s) {
    let n = 0;
    for (let i = 0; i < s.length; i++) {
        let idx = PARAMS.ALFA.indexOf(s[i].toUpperCase());
        n = n * 30 + idx;
    }
    return n;
}

function getGridInfo(lat, lng) {
    const totalNanoX = Math.floor((lng - ORIGIN.lng) / PARAMS.RES_NANO + 1e-9);
    const totalNanoY = Math.floor((ORIGIN.lat - lat) / PARAMS.RES_NANO + 1e-9);

    // Nivel Macro (D√≠gitos 1 y 2)
    const mx = Math.floor(totalNanoX / (24 * 25));
    const my = Math.floor(totalNanoY / (24 * 25));
    
    // Nivel Micro (D√≠gitos 3 y 4) - Usamos el resto de la divisi√≥n anterior
    const microX = Math.floor((totalNanoX % (24 * 25)) / 25);
    const microY = Math.floor((totalNanoY % (24 * 25)) / 25);
    
    // Nivel Nano (D√≠gitos 5 y 6) - El resto final
    const nanoX = totalNanoX % 25;
    const nanoY = totalNanoY % 25;

    return { 
        macro: encode((my * PARAMS.MACRO_X_COUNT) + mx, 2), 
        micro: encode((microY * 24) + microX, 2), 
        nano: encode((nanoY * 25) + nanoX, 2) 
    };
}

function buscarEstafetaCercana(userLat, userLng) {
    let puntoUsuario = L.latLng(userLat, userLng);
    let estafetaMasCercana = null;
    let distanciaMinima = Infinity;

    // Iteramos sobre todas las capas dentro de layerEstafetas
    layerEstafetas.eachLayer(function(layer) {
        // En GeoJSON, los puntos pueden estar dentro de capas internas
        let layers = (layer.getLayers) ? layer.getLayers() : [layer];
        
        layers.forEach(function(l) {
            if (l.getLatLng) {
                let coordsEstafeta = l.getLatLng();
                let distancia = puntoUsuario.distanceTo(coordsEstafeta);
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                    estafetaMasCercana = l;
                }
            }
        });
    });

    if (estafetaMasCercana && estafetaMasCercana.feature) {
        let nombre = estafetaMasCercana.feature.properties.ESTAF_NAME || "Estafeta sin nombre";
        let distKm = (distanciaMinima / 1000).toFixed(2);
        
        // Volamos a la estafeta
        mymap.flyTo(estafetaMasCercana.getLatLng(), 16);

        // Esperamos a que termine el vuelo para abrir el popup
        mymap.once('moveend', function() {
            estafetaMasCercana.bindPopup(`
                <div style="text-align: center;">
                    <b style="color: #28a745;">ESTAFETA ENCONTRADA</b><br>
                    <span style="font-size: 14px; font-weight: bold;">${nombre}</span><br>
                    <hr style="margin: 5px 0;">
                    <p style="margin: 0; font-size: 12px;">Distancia desde su punto:<br>
                    <b style="font-size: 16px;">${distKm} km</b></p>
                </div>
            `).openPopup();
            
            // Dibujamos la l√≠nea de conexi√≥n
            L.polyline([puntoUsuario, estafetaMasCercana.getLatLng()], {
                color: '#003366', 
                weight: 2, 
                dashArray: '5, 10',
                opacity: 0.7
            }).addTo(selectionLayer);
        });
    } else {
        alert("No se encontraron estafetas cargadas en el mapa.");
    }
}

function seleccionar(lat, lng, forcedZonaID = null) {
    selectionLayer.clearLayers();
    const z = mymap.getZoom();
    const step = (z >= 16.5) ? PARAMS.RES_NANO : (z >= 13) ? PARAMS.RES_MICRO : PARAMS.RES_MACRO;

    // Ajuste ultra-preciso a la grilla
    const idxX = Math.floor((lng - ORIGIN.lng) / step + 1e-9);
    const idxY = Math.floor((ORIGIN.lat - lat) / step + 1e-9);

    const snapLng = snapToGrid(lng, ORIGIN.lng, step);
    const snapLat = ORIGIN.lat - snapToGrid(ORIGIN.lat - lat, 0, step);
    
    // El centro del cuadro para validar si est√° dentro de la zona (Polygon)
    const centroCuadro = { lat: snapLat - (step / 2), lng: snapLng + (step / 2) };

    let zonaID = forcedZonaID;
    if (!zonaID) {
        layerZonas.eachLayer(layer => {
            if (layer instanceof L.Polygon && isPointInPolygon(L.latLng(centroCuadro.lat, centroCuadro.lng), layer)) {
                zonaID = layer.feature.properties.VM_LEVEL;
            }
        });
        if (!zonaID) {
            layerZonas.eachLayer(layer => {
                if (layer instanceof L.Polygon && isPointInPolygon(L.latLng(lat, lng), layer)) {
                    zonaID = layer.feature.properties.VM_LEVEL;
                }
            });
        }
    }

    if (!zonaID) {
        L.popup().setLatLng([lat, lng])
            .setContent('<div class="error-msg">‚ö†Ô∏è √ÅREA NO DEFINIDA<br><small style="font-weight:normal; color:grey">Centro de cuadr√≠cula fuera de l√≠mites</small></div>')
            .openOn(mymap);
        return;
    }

    const res = getGridInfo(lat, lng);
    const isZonaVisible = mymap.hasLayer(layerZonas);
    let tituloPopup = "";
    let codigoFinal = "";

    if (isZonaVisible) {
        tituloPopup = "ZONA POSTAL";
        codigoFinal = zonaID;
        codigoFinal += "<br><small style='color:#d9534f; font-weight:normal; display:block; margin-top:5px; font-size:10px;'>Desactive la casilla de Zonas para buscar C√≥digos postales</small>";
    } else {
        if (z >= 16.5) {
            tituloPopup = "C√ìDIGO POSTAL";
            codigoFinal = `${zonaID}-${res.macro}${res.micro}${res.nano}`;
        } else if (z >= 13) {
            tituloPopup = "√ÅREA POSTAL";
            codigoFinal = `${zonaID}-${res.macro}${res.micro}`;
        } else {
            tituloPopup = "SUBZONA POSTAL";
            codigoFinal = `${zonaID}-${res.macro}`;
        }
        L.rectangle([[snapLat, snapLng], [snapLat - step, snapLng + step]], { color: '#f1c40f', weight: 3, fillOpacity: 0.2, interactive: false }).addTo(selectionLayer);
    }

    const pin = L.marker([lat, lng], { 
        icon: L.icon({ 
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', 
            iconSize: [20, 32], iconAnchor: [10, 32] 
        }) 
    });

    pin.addTo(selectionLayer)
       .bindPopup(`
        <span class="popup-header">${tituloPopup}</span>
        <div class="codigo-final">${codigoFinal}</div>
        <div class="btn-container">
            <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" class="btn-maps">üìç MAPS</a>
            <a href="https://wa.me/?text=Mi+${tituloPopup.replace(' ', '+')}+es:+${codigoFinal.split('<br>')[0]}" target="_blank" class="btn-ws">üí¨ WS</a>
            <button onclick="buscarEstafetaCercana(${lat}, ${lng})" class="btn-cercana">üìç ESTAFETA CERCANA</button>
        </div>
      `, { offset: L.point(0, -25), minWidth: 160 })
       .openPopup();

    pin.on('popupclose', () => { selectionLayer.clearLayers(); });
}

document.getElementById('search-btn').addEventListener('click', () => {
    const val = document.getElementById('search-input').value.toUpperCase().replace(/\s/g, '');
    if (val.length !== 6) return;
    try {
        const idM = decode(val.substring(0,2)), idMi = decode(val.substring(2,4)), idN = decode(val.substring(4,6));
        const my = Math.floor(idM / PARAMS.MACRO_X_COUNT), mx = idM % PARAMS.MACRO_X_COUNT;
        const miy = Math.floor(idMi / 24), mix = idMi % 24;
        const nay = Math.floor(idN / 25), nax = idN % 25;
        const lng = ORIGIN.lng + (mx * PARAMS.RES_MACRO) + (mix * PARAMS.RES_MICRO) + (nax * PARAMS.RES_NANO) + (PARAMS.RES_NANO / 2);
        const lat = ORIGIN.lat - (my * PARAMS.RES_MACRO) - (miy * PARAMS.RES_MICRO) - (nay * PARAMS.RES_NANO) - (PARAMS.RES_NANO / 2);
        mymap.flyTo([lat, lng], 18);
        mymap.once('moveend', () => setTimeout(() => seleccionar(lat, lng), 450));
    } catch(e) { alert("C√≥digo inv√°lido"); }
});

function render() {
    layerMacro.clearLayers(); layerMicro.clearLayers(); layerNano.clearLayers();
    const z = mymap.getZoom();
    const b = mymap.getBounds();
    const draw = (step, layer, labelClass, color, weight, opacity) => {
        let sLng = snapToGrid(b.getWest(), ORIGIN.lng, step);
        let sLat = ORIGIN.lat - snapToGrid(ORIGIN.lat - b.getNorth(), 0, step);
        let count = 0;
        for (let lo = sLng; lo < b.getEast() + step && lo < PANAMA_LIMITS.E; lo += step) {
        for (let la = sLat; la > b.getSouth() - step && la > PANAMA_LIMITS.S; la -= step) {
                if (count++ > 400) return;
                const data = getGridInfo(la - step/2, lo + step/2);
                L.rectangle([[la, lo], [la - step, lo + step]], { color: color, weight: weight, fill: false, opacity: opacity, interactive: false }).addTo(layer);
                if (labelClass && ((labelClass==='label-macro' && z < 13) || (labelClass==='label-micro' && z >= 13 && z < 16.5))) {
                    const txt = labelClass === 'label-macro' ? data.macro : data.micro;
                    L.marker([la - step/2, lo + step/2], { icon: L.divIcon({className: 'inv'}) }).bindTooltip(txt, { permanent: true, direction: 'center', className: `watermark-tooltip ${labelClass}` }).addTo(layer);
                }
            }
        }
    };
    if (z >= 9) draw(PARAMS.RES_MACRO, layerMacro, 'label-macro', '#1a73e8', 1.5, 0.2);
    if (z >= 13) draw(PARAMS.RES_MICRO, layerMicro, 'label-micro', '#e67e22', 1, 0.2);
    if (z >= 16.5) draw(PARAMS.RES_NANO, layerNano, '', '#2c3e50', 0.5, 0.15);
}

const overlays = { 
    "üî≤ üó∫Ô∏è Zonas": layerZonas,  
    "üõ£Ô∏è Rutas": layerRutas, 
    "üìç Estafetas": layerEstafetas,
    "üî≤ Cuadr√≠cula": layerMacro,
    "üîµ Mi Ubicaci√≥n": layerMiUbicacion 
};
L.control.layers(null, overlays, { collapsed: false, position: 'topright' }).addTo(mymap);

function findMe() { mymap.locate({setView: true, maxZoom: 18, enableHighAccuracy: true }); }
mymap.on('locationfound', (e) => {
    layerMiUbicacion.clearLayers();
    L.circleMarker(e.latlng, {radius: 8, color: 'white', fillColor: '#1a73e8', fillOpacity: 1, weight: 3}).addTo(layerMiUbicacion);
    seleccionar(e.latlng.lat, e.latlng.lng);
});

mymap.on('click', (e) => seleccionar(e.latlng.lat, e.latlng.lng));
mymap.on('moveend', render);
render();
</script>
</body>
</html>



