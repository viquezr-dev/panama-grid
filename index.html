<!DOCTYPE html>
<html>
<head>
    <title>PanGrid 7C - SoluciÃ³n Clic</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; }
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 2000;
            display: flex; background: white; padding: 5px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); width: 280px;
        }
        input#search-input { flex: 1; border: none; padding: 10px; font-size: 16px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .grid-label { font-size: 10px; font-weight: bold; color: #2980b9; pointer-events: none; text-shadow: 0 0 2px white; }
        .leaflet-popup-content { text-align: center; font-family: sans-serif; }
    </style>
</head>
<body>

<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: EAP3582">
    <button id="search-btn">IR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
    const mymap = L.map('mapid', { zoomControl: false }).setView([8.98, -79.52], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

    const gridLayer = L.layerGroup().addTo(mymap);
    let estafetasLayer;
    let rawGeoData = null;

    // 1. CARGA SEGURA DEL GEOJSON
    $.getJSON("estafetas.geojson", function(data) {
        rawGeoData = data;
        estafetasLayer = L.geoJSON(data, {
            style: { color: "#2c3e50", weight: 2, fillOpacity: 0.1 }
        }).addTo(mymap);
        console.log("GeoJSON cargado correctamente");
    }).fail(function() {
        console.error("Error cargando estafetas.geojson. Verifica el nombre del archivo.");
    });

    // 2. ALGORITMO POSTAL
    function getPostalCode(lat, lon) {
        const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ"; 
        let x_norm = (lon - (-83.05)) / (-77.15 - (-83.05));
        let v_x = Math.floor(x_norm * 999999);
        let lll = "";
        for (let i = 0; i < 3; i++) {
            lll = ALFABETO[Math.max(0, Math.min(v_x % 24, 23))] + lll;
            v_x = Math.floor(v_x / 24);
        }
        let y_norm = (lat - 7.0) / (10.0 - 7.0);
        let y_val = Math.floor(y_norm * 9999999);
        return lll + String(y_val % 10000).padStart(4, '0');
    }
	function generarCOD7(lat, lon) {
    const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";

    const xNorm = (lon - (-83.05)) / (-77.15 - (-83.05));
    if (xNorm < 0 || xNorm >= 1) return null;

    let v = Math.floor(xNorm * Math.pow(24, 3));
    let lll = "";
    for (let i = 0; i < 3; i++) {
        lll = ALFABETO[v % 24] + lll;
        v = Math.floor(v / 24);
    }

    const yNorm = (lat - 7.0) / (10.0 - 7.0);
    if (yNorm < 0 || yNorm >= 1) return null;

    const nnnn = Math.floor(yNorm * 10000)
        .toString()
        .padStart(4, "0");

    return lll + nnnn;
}

    // 3. EVENTO CLIC CORREGIDO
    mymap.on("click", function (e) {

	    let vm = "ZONA NO DEFINIDA";
	
	    if (estafetasLayer && rawGeoData) {
	        const hit = leafletPip.pointInLayer(
	            [e.latlng.lng, e.latlng.lat],
	            estafetasLayer
	        );
	        if (hit.length && hit[0].feature.properties.VM_LEVEL) {
	            vm = hit[0].feature.properties.VM_LEVEL;
	        }
	    }
	
	    // ðŸ”´ Si no hay estafeta â†’ solo texto
	    if (vm === "ZONA NO DEFINIDA") {
	        L.popup()
	            .setLatLng(e.latlng)
	            .setContent("<b>ZONA NO DEFINIDA</b>")
	            .openOn(mymap);
	        return;
	    }
	
	    // ðŸ§  CÃ³digo 7C (MISMA lÃ³gica que QGIS)
	    const cod7 = generarCOD7(e.latlng.lat, e.latlng.lng);
	
	    // ðŸ”’ ValidaciÃ³n estricta
	    if (!cod7 || !/^[A-Z]{3}\d{4}$/.test(cod7)) {
	        L.popup()
	            .setLatLng(e.latlng)
	            .setContent(`<b>${vm}</b>`)
	            .openOn(mymap);
	        return;
	    }
	
	    // âœ… CÃ³digo postal final
	    const postal = `${vm}-${cod7}`;
	
	    L.popup()
	        .setLatLng(e.latlng)
	        .setContent(`
	            <div style="text-align:center;">
	                <div style="font-weight:bold; margin-bottom:6px;">
	                    CÃ“DIGO POSTAL
	                </div>
	                <div style="font-size:22px; font-weight:bold; color:#e67e22;">
	                    ${postal}
	                </div>
	            </div>
	        `)
	        .openOn(mymap);
	});


    // 4. BUSCADOR (Tu lÃ³gica corregida)
    document.getElementById('search-btn').onclick = function() {
        const s7 = document.getElementById('search-input').value.trim().toUpperCase();
        if (s7.length === 7) {
            const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
            const lll = s7.substring(0, 3);
            const nnnn = parseInt(s7.substring(3));

            let v_x = 0;
            for(let i = 0; i < 3; i++) v_x = v_x * 24 + ALFABETO.indexOf(lll[i]);

            let lon = ((v_x + 0.5) / 999999) * (-77.15 - (-83.05)) + (-83.05);
            let lat = ((nnnn + 0.5) / 10000) * (10.0 - 7.0) + 7.0;

            mymap.setView([lat, lon], 19);
            
            // Limpiar marcador anterior
            gridLayer.eachLayer(l => { if(l instanceof L.Marker && l.options.icon === undefined) gridLayer.removeLayer(l); });

            L.marker([lat, lon]).addTo(mymap).bindPopup("<b>" + s7 + "</b>").openPopup();
        }
    };

    // 5. REJILLA
    function updateGrid() {
        gridLayer.clearLayers();
        if (mymap.getZoom() < 17) return;
        const b = mymap.getBounds();
        const sX = 0.00045, sY = 0.00035;
        for (let x = Math.floor(b.getWest()/sX)*sX; x <= b.getEast(); x += sX) {
            for (let y = Math.floor(b.getSouth()/sY)*sY; y <= b.getNorth(); y += sY) {
                const lat = y + sY/2, lon = x + sX/2;
                const code = generarCOD7(lat, lon);
				if (!code) continue;
                L.rectangle([[y, x], [y + sY, x + sX]], { color: "#3498db", weight: 0.5, fillOpacity: 0.03, interactive: false }).addTo(gridLayer);
                if (mymap.getZoom() >= 18) {
                    L.marker([lat, lon], { icon: L.divIcon({ className: 'grid-label', html: code, iconSize: [60, 20] }), interactive: false }).addTo(gridLayer);
                }
            }
        }
    }
    mymap.on('moveend zoomend', updateGrid);
</script>
</body>
</html>


