<!DOCTYPE html>
<html>
<head>
    <title>PanGrid 7C - Interfaz Corregida</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; }
        
        /* Contenedor del Buscador */
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 3000;
            display: flex; background: white; padding: 5px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 260px;
        }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 16px; outline: none; width: 100px; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Ajuste del Selector de Capas (Casillas) */
        .leaflet-top.leaflet-right {
            top: 70px !important; /* Lo bajamos para que no choque con el buscador */
        }
        .leaflet-control-layers {
            box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
            border: none !important;
            border-radius: 8px !important;
        }

        /* Estilo del Bot贸n "D贸nde estoy" */
        .locate-button {
            background: white;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            border-radius: 5px;
            font-size: 18px;
            border: 2px solid rgba(0,0,0,0.2);
            background-clip: padding-box;
        }
        .locate-button:hover { background-color: #f4f4f4; }

        .grid-label { font-size: 10px; font-weight: bold; color: #2980b9; pointer-events: none; text-shadow: 0 0 2px white; }
    </style>
</head>
<body>

<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: FRE8745">
    <button id="search-btn">IR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// 1. Inicializaci贸n
const mymap = L.map('mapid', { zoomControl: true }).setView([8.98, -79.52], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
let estafetasLayer = L.layerGroup().addTo(mymap);
let estafetaslLayer = L.layerGroup().addTo(mymap);
let estafetaspLayer = L.layerGroup().addTo(mymap);
let rawGeoData = null;

// 2. Carga de Datos
$.getJSON("estafetas.geojson", function(data) {
    rawGeoData = data;
    L.geoJSON(data, { style: { color: "#2c3e50", weight: 2, fillOpacity: 0.1 } }).addTo(estafetasLayer);
});

$.getJSON("estafetasl.geojson", function(data) {
    L.geoJSON(data, { style: { color: "#e74c3c", weight: 3 }, 
        onEachFeature: (f, l) => l.bindPopup(`<b>RUTA:</b> ${f.properties.RUTA || "S/R"}`) 
    }).addTo(estafetaslLayer);
});

$.getJSON("estafetasp.geojson", function(data) {
    L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, {radius:6, color:"#27ae60", fillOpacity:1}),
        onEachFeature: (f, l) => l.bindPopup(`<b>ESTAFETA:</b> ${f.properties.ESTAF_NAME || "S/N"}`)
    }).addTo(estafetaspLayer);
});

// 3. Control de Capas (Posicionado a la derecha, aparecer谩 debajo del buscador)
const overlayMaps = {
    "Pol铆gonos": estafetasLayer,
    "Rutas (L铆neas)": estafetaslLayer,
    "Estafetas (Puntos)": estafetaspLayer
};
L.control.layers(null, overlayMaps, {collapsed:false, position: 'topright'}).addTo(mymap);

// 4. Bot贸n Personalizado "D贸nde estoy" (Ubicado arriba a la izquierda)
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', 'locate-button', container);
        button.innerHTML = '';
        button.title = "Mi ubicaci贸n";
        
        L.DomEvent.on(button, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            mymap.locate({setView: true, maxZoom: 18});
        });
        return container;
    }
});
mymap.addControl(new LocateControl());

mymap.on('locationfound', (e) => {
    L.circle(e.latlng, {radius: 10, color: '#3498db'}).addTo(mymap);
});

// 5. L贸gica Postal
function generarCOD7(lat, lon) {
    const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    const xNorm = (lon - (-83.05)) / (-77.15 - (-83.05));
    if (xNorm < 0 || xNorm >= 1) return null;
    let v = Math.floor(xNorm * 13824);
    let lll = "";
    for (let i = 0; i < 3; i++) { lll = ALFABETO[v % 24] + lll; v = Math.floor(v / 24); }
    const yNorm = (lat - 7.0) / (10.0 - 7.0);
    const nnnn = Math.floor(yNorm * 10000).toString().padStart(4, "0");
    return lll + nnnn;
}

// 6. Clic y Buscador
mymap.on("click", function (e) {
    let vm = "S/Z"; // Valor por defecto si no hay zona
    
    // 1. Identificar la zona (VM_LEVEL) a trav茅s del GeoJSON
    if (rawGeoData) {
        const hit = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawGeoData));
        if (hit.length > 0) {
            vm = hit[0].feature.properties.VM_LEVEL || "S/Z";
        }
    }

    let contenido = "";
    const zoomActual = mymap.getZoom();

    if (zoomActual < 17) {
        // NIVEL 1: Zoom alejado - Solo muestra la zona del pol铆gono
        contenido = `<div style="text-align:center;">
                        <b style="color:#2c3e50;">CDIGO POSTAL</b><br>
                        <span style="font-size:18px; font-weight:bold;">${vm}</span>
                     </div>`;
    } else {
        // NIVEL 2: Zoom de precisi贸n (Grid visible)
        // Genera el c贸digo de 7 caracteres y lo concatena con el VM_LEVEL
        const gridCode = generarCOD7(e.latlng.lat, e.latlng.lng);
        const fullPostalCode = `${vm}-${gridCode}`;
        
        contenido = `<div style="text-align:center;">
                        <b style="color:#2c3e50;">CDIGO POSTAL</b><br>
                        <span style="font-size:20px; font-weight:bold; color:#e67e22;">${fullPostalCode}</span>
                     </div>`;
    }
    
    L.popup()
        .setLatLng(e.latlng)
        .setContent(contenido)
        .openOn(mymap);
});

// 7. Rejilla
function updateGrid() {
    gridLayer.clearLayers();
    if (mymap.getZoom() < 17) return;
    const b = mymap.getBounds();
    const sX = 0.00045, sY = 0.00035;
    for (let x = Math.floor(b.getWest()/sX)*sX; x <= b.getEast(); x += sX) {
        for (let y = Math.floor(b.getSouth()/sY)*sY; y <= b.getNorth(); y += sY) {
            const lat = y+sY/2, lon = x+sX/2;
            const code = generarCOD7(lat, lon);
            L.rectangle([[y,x],[y+sY,x+sX]], {color:"#3498db", weight:0.4, fillOpacity:0.03, interactive:false}).addTo(gridLayer);
            if (mymap.getZoom()>=18) {
                L.marker([lat, lon], {icon:L.divIcon({className:'grid-label', html:code, iconSize:[60,20]}), interactive:false}).addTo(gridLayer);
            }
        }
    }
}
mymap.on('moveend zoomend', updateGrid);

</script>
</body>
</html>


