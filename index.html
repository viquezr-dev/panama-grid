<!DOCTYPE html>
<html>
<head>
    <title>PanGrid 7C - Versi√≥n Corregida</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; }
        
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            display: flex; background: white; padding: 5px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px;
        }
        
        input#search-input { 
            flex: 1; border: 1px solid #ddd; padding: 8px; 
            font-size: 16px; outline: none; border-radius: 4px;
        }
        
        button#search-btn { 
            background: #2c3e50; color: white; border: none; 
            padding: 8px 15px; border-radius: 4px; cursor: pointer;
            margin-left: 5px;
        }
        
        .loc-button {
            position: absolute; top: 70px; right: 10px; z-index: 1000;
            background: white; width: 44px; height: 44px; display: flex;
            align-items: center; justify-content: center; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; 
            font-size: 20px; border: 1px solid #ccc;
        }
        
        .grid-label { 
            font-size: 10px; font-weight: bold; color: #2980b9; 
            text-shadow: 0 0 2px white; pointer-events: none; 
        }
        
        .info-panel {
            position: absolute; bottom: 20px; left: 20px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px;
        }
    </style>
</head>
<body>

<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: EAP3582">
    <button id="search-btn">IR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
    // ==================== 1. INICIALIZACI√ìN ====================
    const mymap = L.map('mapid', { zoomControl: false }).setView([8.98, -79.52], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);
    L.control.zoom({ position: 'bottomright' }).addTo(mymap);
    
    const gridLayer = L.layerGroup().addTo(mymap);
    let rawGeoData = null;
    
    const estafetasLayer = L.geoJSON(null, {
        style: { color: "#2c3e50", weight: 2, fillOpacity: 0.1 }
    }).addTo(mymap);
    
    // Cargar GeoJSON
    $.getJSON("estafetas.geojson", function(data) {
        rawGeoData = data;
        estafetasLayer.addData(data);
    }).fail(function() {
        console.warn("No se pudo cargar estafetas.geojson");
    });
    
    // ==================== 2. ALGORITMO PANGRID 7C CORREGIDO ====================
    const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    
    // CONSTANTES DE RANGO PARA PANAM√Å
    const LON_WEST = -83.05;   // L√≠mite oeste (frontera con Costa Rica)
    const LON_EAST = -77.15;   // L√≠mite este (frontera con Colombia)
    const LAT_SOUTH = 7.0;     // L√≠mite sur
    const LAT_NORTH = 10.0;    // L√≠mite norte
    
    const LON_RANGE = LON_EAST - LON_WEST;  // 5.9 grados
    const LAT_RANGE = LAT_NORTH - LAT_SOUTH; // 3.0 grados
    
    // Funci√≥n ORIGINAL para generar c√≥digo desde coordenadas
    function getPostalCode(lat, lon) {
        // Normalizar longitud
        let x_norm = (lon - LON_WEST) / LON_RANGE;
        let x_val = Math.floor(x_norm * 999999);
        
        // Convertir a 3 letras
        let lll = "";
        let v_x = x_val;
        for (let i = 0; i < 3; i++) {
            lll = ALFABETO[Math.max(0, Math.min(v_x % 24, 23))] + lll;
            v_x = Math.floor(v_x / 24);
        }
        
        // Normalizar latitud - CORRECTO: 9999999 celdas
        let y_norm = (lat - LAT_SOUTH) / LAT_RANGE;
        let y_val = Math.floor(y_norm * 9999999);
        
        // Tomar √∫ltimos 4 d√≠gitos (m√≥dulo 10000)
        let nnnn = y_val % 10000;
        
        // Retornar c√≥digo LLLNNNN
        return lll + String(nnnn).padStart(4, '0');
    }
    
    // Funci√≥n INVERSA CORREGIDA - de c√≥digo a coordenadas
    function getCoordsFromPostalCode(s7) {
        // Extraer componentes
        const lll = s7.substring(0, 3);
        const nnnn = parseInt(s7.substring(3, 7));  // Los √∫ltimos 4 d√≠gitos
        
        // PASO 1: Decodificar las letras para obtener x_val
        let x_val = 0;
        for(let i = 0; i < 3; i++) {
            const charIndex = ALFABETO.indexOf(lll[i]);
            if (charIndex === -1) {
                throw new Error(`Letra inv√°lida: ${lll[i]}`);
            }
            x_val = x_val * 24 + charIndex;
        }
        
        // x_val est√° en el rango 0-999999 (13824 combinaciones posibles)
        
        // PASO 2: Calcular longitud del CENTRO de la celda
        // Usamos x_val + 0.5 para centrar en la celda
        const lon_norm = (x_val + 0.5) / 999999;
        const lon = LON_WEST + (lon_norm * LON_RANGE);
        
        // PASO 3: Para la latitud, nnnn representa y_val % 10000
        // PERO no sabemos el y_val completo, solo sabemos nnnn
        // Esto causa ambig√ºedad. Asumimos el valor m√°s probable.
        
        // El problema: hay m√∫ltiples valores de y_val que dan el mismo nnnn
        // Ejemplo: nnnn=1234 podr√≠a ser de y_val=1234, 11234, 21234, etc.
        // Para Panam√°, usamos el rango medio: y_val = nnnn + 5000
        
        // CORRECCI√ìN IMPORTANTE: nnnn es y_val % 10000
        // Para obtener latitud, necesitamos y_val / 9999999
        // Como no sabemos y_val exacto, usamos nnnn / 10000 como aproximaci√≥n
        
        // Esto es una aproximaci√≥n - el sistema no es completamente reversible
        const lat_norm = (nnnn + 0.5) / 10000;  // Centrado en la celda
        const lat = LAT_SOUTH + (lat_norm * LAT_RANGE);
        
        console.log(`C√≥digo: ${s7}, x_val: ${x_val}, nnnn: ${nnnn}`);
        console.log(`Coords: ${lat.toFixed(6)}, ${lon.toFixed(6)}`);
        
        return {
            lat: lat,
            lon: lon,
            x_val: x_val,
            nnnn: nnnn,
            codigo: s7
        };
    }
    
    // ==================== 3. CLIC EN EL MAPA ====================
    mymap.on('click', function(e) {
        if (!rawGeoData) return;
        
        const results = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], estafetasLayer);
        const code = getPostalCode(e.latlng.lat, e.latlng.lng);
        
        if (results.length > 0) {
            const vm = results[0].feature.properties.VM_LEVEL || "ZONA POSTAL";
            L.popup().setLatLng(e.latlng)
                .setContent(`<b>${vm}</b><br><span style="font-size:18px; color:#d35400; font-weight:bold;">${code}</span>`)
                .openOn(mymap);
        } else {
            L.popup().setLatLng(e.latlng)
                .setContent(`<b>Fuera de √°rea</b><br><span style="font-size:18px; color:#7f8c8d;">${code}</span>`)
                .openOn(mymap);
        }
    });
    
    // ==================== 4. BOT√ìN GPS ====================
    const locBtn = L.control({position: 'topright'});
    locBtn.onAdd = function() {
        const div = L.DomUtil.create('div', 'loc-button');
        div.innerHTML = 'üéØ';
        div.onclick = function(e) {
            L.DomEvent.stopPropagation(e);
            mymap.locate({setView: true, maxZoom: 16});
        };
        return div;
    };
    locBtn.addTo(mymap);
    
    mymap.on('locationfound', function(e) {
        L.circleMarker(e.latlng, {radius: 8, color: '#007bff'}).addTo(mymap);
    });
    
    // ==================== 5. BUSCADOR CORREGIDO ====================
    document.getElementById('search-btn').onclick = function() {
        buscarCodigo();
    };
    
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarCodigo();
        }
    });
    
    // Limpiar marcadores anteriores
    function limpiarMarcadores() {
        mymap.eachLayer(function(layer) {
            if (layer instanceof L.Marker || 
                (layer instanceof L.CircleMarker && layer.options.color === '#ff0000')) {
                mymap.removeLayer(layer);
            }
        });
    }
    
    // Funci√≥n principal de b√∫squeda
    function buscarCodigo() {
        const input = document.getElementById('search-input').value.trim().toUpperCase();
        
        if (input.length === 0) return;
        
        // Limpiar marcadores anteriores
        limpiarMarcadores();
        
        // Validar formato b√°sico
        if (!/^[A-Z]{3}\d{4}$/.test(input)) {
            alert("Formato inv√°lido. Use 3 letras + 4 n√∫meros. Ejemplo: EAP3582");
            return;
        }
        
        try {
            // Obtener coordenadas
            const resultado = getCoordsFromPostalCode(input);
            const lat = resultado.lat;
            const lon = resultado.lon;
            
            // VERIFICAR SI EST√Å DENTRO DE PANAM√Å
            console.log("Verificando coordenadas:", lat, lon);
            console.log("L√≠mites:", LAT_SOUTH, LAT_NORTH, LON_WEST, LON_EAST);
            
            if (lon >= LON_WEST && lon <= LON_EAST && 
                lat >= LAT_SOUTH && lat <= LAT_NORTH) {
                
                // Est√° dentro de Panam√° - ir a la ubicaci√≥n
                mymap.setView([lat, lon], 18);
                
                // Crear marcador
                const marker = L.circleMarker([lat, lon], {
                    radius: 10,
                    color: '#ff0000',
                    fillColor: '#ff0000',
                    fillOpacity: 0.8,
                    weight: 3
                }).addTo(mymap);
                
                // Calcular l√≠mites de la celda para mostrar
                const cellWidth = LON_RANGE / 999999;
                const cellHeight = LAT_RANGE / 10000; // Aproximaci√≥n
                
                const west = lon - cellWidth/2;
                const east = lon + cellWidth/2;
                const south = lat - cellHeight/2;
                const north = lat + cellHeight/2;
                
                // Dibujar rect√°ngulo de la celda
                L.rectangle([[south, west], [north, east]], {
                    color: '#ff0000',
                    weight: 2,
                    fillOpacity: 0.1
                }).addTo(mymap);
                
                // Mostrar popup
                marker.bindPopup(`
                    <b>C√≥digo:</b> ${input}<br>
                    <b>Coordenadas:</b><br>
                    ${lat.toFixed(6)}¬∞, ${lon.toFixed(6)}¬∞<br>
                    <small>Centro de la celda postal</small>
                `).openPopup();
                
                console.log("‚úÖ B√∫squeda exitosa en Panam√°");
                
            } else {
                // Fuera de Panam√°
                alert("‚ö†Ô∏è ADVERTENCIA: Este c√≥digo est√° fuera del territorio de Panam√°\n\n" +
                     "Coordenadas calculadas: " + lat.toFixed(4) + "¬∞, " + lon.toFixed(4) + "¬∞\n" +
                     "¬øDesea ir a esta ubicaci√≥n de todos modos?");
                
                // Preguntar si quiere ir de todos modos
                if (confirm("¬øIr a esta ubicaci√≥n fuera de Panam√°?")) {
                    mymap.setView([lat, lon], 16);
                    
                    L.marker([lat, lon])
                        .addTo(mymap)
                        .bindPopup(`<b>‚ö†Ô∏è Fuera de Panam√°</b><br>C√≥digo: ${input}`)
                        .openPopup();
                }
            }
            
        } catch (error) {
            alert("Error: " + error.message);
            console.error(error);
        }
    }
    
    // ==================== 6. FUNCI√ìN PARA PRUEBAS ====================
    // Funci√≥n para probar c√≥digos que S√ç deber√≠an estar en Panam√°
    function probarCodigosPanama() {
        const codigosPrueba = [
            "EAP3582",  // Cerca de Ciudad de Panam√°
            "MMM5000",  // Centro aproximado
            "CCC2500",  // Zona central
            "JJJ7500",  // Zona oriental
            "AAA1000",  // Noroeste
            "ZZZ9000"   // Sureste
        ];
        
        console.log("=== PRUEBA DE C√ìDIGOS EN PANAM√Å ===");
        
        codigosPrueba.forEach(codigo => {
            try {
                const coords = getCoordsFromPostalCode(codigo);
                console.log(`${codigo}: ${coords.lat.toFixed(4)}, ${coords.lon.toFixed(4)}`);
                
                // Verificar si est√° en Panam√°
                const enPanama = (coords.lon >= LON_WEST && coords.lon <= LON_EAST && 
                                 coords.lat >= LAT_SOUTH && coords.lat <= LAT_NORTH);
                
                console.log(`  ${enPanama ? '‚úÖ EN PANAM√Å' : '‚ùå FUERA DE PANAM√Å'}`);
                
            } catch (e) {
                console.log(`${codigo}: ERROR - ${e.message}`);
            }
        });
    }
    
    // Ejecutar prueba al cargar
    setTimeout(probarCodigosPanama, 1000);
    
    // ==================== 7. REJILLA VISUAL ====================
    function updateGrid() {
        gridLayer.clearLayers();
        if (mymap.getZoom() < 17) return;
        
        const b = mymap.getBounds();
        const sX = 0.00045, sY = 0.00035;
        
        for (let x = Math.floor(b.getWest()/sX)*sX; x <= b.getEast(); x += sX) {
            for (let y = Math.floor(b.getSouth()/sY)*sY; y <= b.getNorth(); y += sY) {
                const clat = y + sY/2, clon = x + sX/2;
                const code = getPostalCode(clat, clon);
                
                L.rectangle([[y, x], [y + sY, x + sX]], {
                    color: "#3498db", 
                    weight: 0.5, 
                    fillOpacity: 0.05,
                    interactive: false
                }).addTo(gridLayer);
                
                if (mymap.getZoom() >= 18) {
                    L.marker([clat, clon], {
                        icon: L.divIcon({
                            className: 'grid-label', 
                            html: code, 
                            iconSize: [60, 20]
                        })
                    }).addTo(gridLayer);
                }
            }
        }
    }
    
    mymap.on('moveend zoomend', updateGrid);
    
    // ==================== 8. INFORMACI√ìN INICIAL ====================
    console.log("=== SISTEMA PANGRID 7C INICIALIZADO ===");
    console.log("Rango de Panam√°:");
    console.log(`  Longitud: ${LON_WEST}¬∞ a ${LON_EAST}¬∞`);
    console.log(`  Latitud: ${LAT_SOUTH}¬∞ a ${LAT_NORTH}¬∞`);
    console.log("Para probar, use c√≥digos como: EAP3582, MMM5000, CCC2500");
    
    // Mostrar coordenadas actuales del centro
    const center = mymap.getCenter();
    const centerCode = getPostalCode(center.lat, center.lng);
    console.log(`Centro actual: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
    console.log(`C√≥digo en centro: ${centerCode}`);
</script>
</body>
</html>
