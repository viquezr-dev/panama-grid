<!DOCTYPE html>
<html>
<head>
    <title>PanGrid 7C – Visor Oficial</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <style>
        html, body, #mapid { height: 100%; margin: 0; }
        .search-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2000;
            display: flex;
            background: white;
            padding: 6px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,.3);
        }
        #search-input {
            border: none;
            outline: none;
            padding: 8px;
            font-size: 15px;
            width: 140px;
        }
        #search-btn {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        .grid-label {
            font-size: 10px;
            font-weight: bold;
            color: #1f4e79;
            pointer-events: none;
            text-shadow: 0 0 2px white;
        }
    </style>
</head>

<body>

<div class="search-container">
    <input id="search-input" placeholder="Ej: STL8532">
    <button id="search-btn">IR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
/* ============================================================
   CONFIGURACIÓN OFICIAL (IGUAL QUE QGIS)
============================================================ */

const CELL_X = 0.00045;
const CELL_Y = 0.00035;
const ALFABETO = "23456789ABCDEFGHJKMNPQRSTUVWXYZ";

/* ============================================================
   MAPA
============================================================ */

const map = L.map("mapid").setView([8.98, -79.52], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const gridLayer = L.layerGroup().addTo(map);
let estafetasLayer = null;
let rawGeoData = null;

/* ============================================================
   CARGA DE ESTAFETAS
============================================================ */

$.getJSON("estafetas.geojson", function (data) {
    rawGeoData = data;
    estafetasLayer = L.geoJSON(data, {
        style: { color: "#2c3e50", weight: 2, fillOpacity: 0.1 }
    }).addTo(map);
    console.log("✔ Estafetas cargadas");
}).fail(function () {
    console.error("❌ Error cargando estafetas.geojson");
});

/* ============================================================
   GENERADOR COD_7CAR (ESPEJO QGIS)
============================================================ */

function getCod7Car(lat, lon) {

    const ix = Math.floor(lon / CELL_X);
    const iy = Math.floor(lat / CELL_Y);

    let h = (ix * 73856093) ^ (iy * 19349663);
    h = Math.abs(h);

    let lll = "";
    for (let i = 0; i < 3; i++) {
        lll = ALFABETO[h % 32] + lll;
        h = Math.floor(h / 32);
    }

    const nnnn = (ix + iy) % 10000;
    return lll + String(nnnn).padStart(4, "0");
}

/* ============================================================
   CLICK → CÓDIGO POSTAL
============================================================ */

map.on("click", function (e) {

    let vm = "ZONA NO DEFINIDA";

    if (estafetasLayer && rawGeoData) {
        const hit = leafletPip.pointInLayer(
            [e.latlng.lng, e.latlng.lat],
            estafetasLayer
        );
        if (hit.length > 0) {
            vm = hit[0].feature.properties.VM_LEVEL || vm;
        }
    }

    const cod7 = getCod7Car(e.latlng.lat, e.latlng.lng);
    const postal = vm + "-" + cod7;

    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <b>${vm}</b><br>
            <span style="font-size:22px;font-weight:bold">${postal}</span>
        `)
        .openOn(map);
});

/* ============================================================
   BUSCADOR (REFERENCIAL)
============================================================ */

document.getElementById("search-btn").onclick = function () {
    const s7 = document.getElementById("search-input").value.trim().toUpperCase();
    if (s7.length !== 7) return;

    // Aproximación visual (no reversible exacto)
    map.setZoom(19);
};

/* ============================================================
   GRID VISUAL
============================================================ */

function updateGrid() {

    gridLayer.clearLayers();
    if (map.getZoom() < 17) return;

    const b = map.getBounds();

    for (let x = Math.floor(b.getWest()/CELL_X)*CELL_X; x <= b.getEast(); x += CELL_X) {
        for (let y = Math.floor(b.getSouth()/CELL_Y)*CELL_Y; y <= b.getNorth(); y += CELL_Y) {

            const lat = y + CELL_Y/2;
            const lon = x + CELL_X/2;
            const code = getCod7Car(lat, lon);

            L.rectangle([[y, x], [y+CELL_Y, x+CELL_X]], {
                color: "#3498db",
                weight: 0.5,
                fillOpacity: 0.03,
                interactive: false
            }).addTo(gridLayer);

            if (map.getZoom() >= 18) {
                L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: "grid-label",
                        html: code,
                        iconSize: [60, 20]
                    }),
                    interactive: false
                }).addTo(gridLayer);
            }
        }
    }
}

map.on("moveend zoomend", updateGrid);
</script>

</body>
</html>
